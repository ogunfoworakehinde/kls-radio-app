name: Build Android APK and AAB

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'www.klsr.com' }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'www.klsr.com' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Cordova and dependencies
      run: |
        npm install -g cordova@12.0.0
        npm install

    - name: Clean previous installations
      run: |
        echo "Cleaning previous installations..."
        rm -rf platforms/ plugins/ node_modules/ 2>/dev/null || true
        npm install

    - name: Create minimal Cordova project structure
      run: |
        echo "Setting up project structure..."
        
        # Create minimal package.json if not exists
        if [ ! -f "package.json" ]; then
          cat > package.json << 'EOF'
{
  "name": "kls-radio-app",
  "version": "1.0.0",
  "description": "KLS Radio Application",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": ["radio", "streaming", "audio"],
  "author": "KLS Radio Team",
  "license": "MIT"
}
EOF
        fi
        
        # Create www directory if not exists
        mkdir -p www
        if [ ! -f "www/index.html" ]; then
          cat > www/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KLS Radio</title>
</head>
<body>
    <h1>KLS Radio</h1>
    <p>Loading application...</p>
</body>
</html>
EOF
        fi

    - name: Create splash screen and icon
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        mkdir -p www/images
        convert -size 1080x1920 xc:"#0a0f2d" www/images/splash.png
        convert -size 512x512 xc:"#0a0f2d" -fill "#d4af37" -draw "circle 256,256 256,400" -pointsize 100 -fill "white" -font "Arial-Bold" -gravity center -annotate +0+0 "KLS" www/images/icon.png

    - name: Fix and validate config.xml
      run: |
        echo "Validating config.xml..."
        if [ -f "config.xml" ]; then
          # Remove problematic android namespace
          sed -i 's|xmlns:android="[^"]*"||g' config.xml
          # Ensure it's a valid Cordova config
          if ! grep -q "cordova.apache.org" config.xml; then
            sed -i 's|xmlns="[^"]*"|xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0"|' config.xml
          fi
          echo "✅ config.xml fixed and validated"
          echo "First 10 lines of config.xml:"
          head -10 config.xml
        else
          echo "❌ config.xml not found!"
          exit 1
        fi

    - name: Initialize Cordova project
      run: |
        echo "Initializing Cordova project..."
        # Create a fresh Cordova project in a temporary directory to get proper structure
        TEMP_DIR=$(mktemp -d)
        cd $TEMP_DIR
        cordova create temp-app com.kingdomlifestyleradio.klsradio "KLS Radio"
        
        # Copy the config.xml from our project
        cp -f $GITHUB_WORKSPACE/config.xml $TEMP_DIR/temp-app/config.xml
        
        # Go back to workspace
        cd $GITHUB_WORKSPACE
        
        # Copy Cordova project files if missing
        if [ ! -f "package.json" ] || ! grep -q "cordova" package.json; then
          cp $TEMP_DIR/temp-app/package.json package.json
          npm install
        fi
        
        echo "✅ Cordova project initialized"

    - name: Add Android platform with verbose output
      run: |
        echo "Adding Android platform..."
        cordova platform add android@13.0.0 --verbose
        
        echo ""
        echo "=== VERIFICATION ==="
        echo "1. Checking platforms directory:"
        ls -la platforms/ || echo "No platforms directory"
        
        echo ""
        echo "2. Listing platforms:"
        cordova platform ls
        
        echo ""
        echo "3. Checking if Android platform exists:"
        if [ -d "platforms/android" ]; then
          echo "✅ Android platform directory exists"
          echo "Android platform contents:"
          ls -la platforms/android/
        else
          echo "❌ Android platform directory does not exist!"
          echo "Creating it manually..."
          mkdir -p platforms/android
        fi

    - name: Install required plugins
      run: |
        echo "Installing Cordova plugins..."
        cordova plugin add cordova-plugin-whitelist@1.3.4
        cordova plugin add cordova-plugin-network-information@3.0.0
        cordova plugin add cordova-plugin-splashscreen@6.0.1
        cordova plugin add cordova-plugin-statusbar@4.0.0
        cordova plugin add cordova-plugin-device@2.1.0
        cordova plugin add cordova-plugin-file@8.1.3
        cordova plugin add cordova-plugin-android-permissions@1.1.3
        cordova plugin add cordova-plugin-media@5.0.3
        cordova plugin add cordova-plugin-background-mode@0.7.3
        
        echo "✅ Plugins installed"
        cordova plugin list

    - name: Verify project setup
      run: |
        echo "=== FINAL VERIFICATION ==="
        echo "Current directory: $PWD"
        echo ""
        echo "Directory structure:"
        ls -la
        echo ""
        echo "Platforms:"
        cordova platform ls
        echo ""
        echo "Plugins:"
        cordova plugin ls
        echo ""
        echo "Config.xml exists:" && test -f config.xml && echo "✅ Yes" || echo "❌ No"
        echo "Android platform exists:" && test -d platforms/android && echo "✅ Yes" || echo "❌ No"

    - name: Setup keystore
      run: |
        echo "Setting up keystore..."
        if [ -f "build.json" ]; then
          echo "✅ build.json exists"
        else
          echo "❌ build.json not found"
          exit 1
        fi
        
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "Using keystore from GitHub secret"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > klsradio-release.keystore
        elif [ -f klsradio-release.keystore ]; then
          echo "Using existing keystore file"
        else
          echo "Creating debug keystore"
          keytool -genkey -v -keystore klsradio-release.keystore \
            -alias klsradio_release -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass "www.klsr.com" -keypass "www.klsr.com" \
            -dname "CN=KLS Radio, OU=Mobile, O=Kingdom Lifestyle, L=Lagos, ST=Lagos, C=NG"
        fi
        echo "✅ Keystore setup complete"

    - name: Build Android Debug APK
      run: |
        echo "Building Debug APK..."
        cordova build android --debug --verbose
        echo "✅ Debug APK built"
        
        echo "Checking build output..."
        find platforms/android -name "*.apk" -type f 2>/dev/null | xargs ls -la || echo "No APK files found"

    - name: Build Android Release AAB
      run: |
        echo "Building Release AAB..."
        cordova build android --release -- --packageType=bundle --buildConfig=build.json
        echo "✅ Release AAB built"

    - name: Build Android Release APK
      run: |
        echo "Building Release APK..."
        cordova build android --release -- --buildConfig=build.json
        echo "✅ Release APK built"

    - name: Upload Debug artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-debug
        path: platforms/android/app/build/outputs/apk/debug/*.apk
        if-no-files-found: error
        retention-days: 14

    - name: Upload Release AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-release-aab
        path: platforms/android/app/build/outputs/bundle/release/*.aab
        if-no-files-found: error
        retention-days: 14

    - name: Upload Release APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-release-apk
        path: platforms/android/app/build/outputs/apk/release/*.apk
        if-no-files-found: warn
        retention-days: 14
