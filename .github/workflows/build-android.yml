name: Build Android APK and AAB

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'www.klsr.com' }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'www.klsr.com' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Cordova and dependencies
      run: |
        npm install -g cordova@12.0.0
        npm install

    - name: Fix config.xml if needed
      run: |
        echo "Checking config.xml..."
        if [ -f "config.xml" ]; then
          echo "✅ config.xml found"
          # Remove problematic android namespace
          sed -i 's|xmlns:android="http://schemas.android.com/apk/res/android"||g' config.xml
          echo "✅ Fixed config.xml"
        else
          echo "❌ config.xml not found"
          exit 1
        fi

    - name: Create splash screen and icon
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        mkdir -p www/images
        convert -size 1080x1920 xc:"#0a0f2d" www/images/splash.png
        convert -size 512x512 xc:"#0a0f2d" -fill "#d4af37" -draw "circle 256,256 256,400" -pointsize 100 -fill "white" -font "Arial-Bold" -gravity center -annotate +0+0 "KLS" www/images/icon.png

    - name: Add Android platform
      run: |
        echo "Adding Android platform..."
        cordova platform add android@13.0.0
        echo "✅ Android platform added"

    - name: Install required plugins
      run: |
        echo "Installing Cordova plugins..."
        cordova plugin add cordova-plugin-whitelist@1.3.4
        cordova plugin add cordova-plugin-network-information@3.0.0
        cordova plugin add cordova-plugin-splashscreen@6.0.1
        cordova plugin add cordova-plugin-statusbar@4.0.0
        cordova plugin add cordova-plugin-device@2.1.0
        cordova plugin add cordova-plugin-file@8.1.3
        cordova plugin add cordova-plugin-android-permissions@1.1.3
        cordova plugin add cordova-plugin-media@5.0.3
        cordova plugin add cordova-plugin-background-mode@0.7.3
        echo "✅ Plugins installed"

    - name: Verify keystore configuration
      run: |
        echo "Checking build.json..."
        if [ -f "build.json" ]; then
          echo "✅ build.json exists"
          cat build.json
        else
          echo "❌ build.json not found"
          exit 1
        fi

    - name: Setup keystore
      run: |
        echo "Setting up keystore..."
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "Using keystore from GitHub secret"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > klsradio-release.keystore
        elif [ -f klsradio-release.keystore ]; then
          echo "Using existing keystore file"
        else
          echo "Creating debug keystore"
          keytool -genkey -v -keystore klsradio-release.keystore \
            -alias klsradio_release -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass "www.klsr.com" -keypass "www.klsr.com" \
            -dname "CN=KLS Radio, OU=Mobile, O=Kingdom Lifestyle, L=Lagos, ST=Lagos, C=NG"
        fi
        echo "✅ Keystore setup complete"

    - name: Build Android Debug APK
      run: |
        echo "Building Debug APK..."
        cordova build android --debug
        echo "✅ Debug APK built"

    - name: Build Android Release AAB
      run: |
        echo "Building Release AAB..."
        cordova build android --release -- --packageType=bundle --buildConfig=build.json
        echo "✅ Release AAB built"

    - name: Build Android Release APK
      run: |
        echo "Building Release APK..."
        cordova build android --release -- --buildConfig=build.json
        echo "✅ Release APK built"

    - name: Upload Debug artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-debug
        path: platforms/android/app/build/outputs/apk/debug/*.apk
        if-no-files-found: error
        retention-days: 14

    - name: Upload Release AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-release-aab
        path: platforms/android/app/build/outputs/bundle/release/*.aab
        if-no-files-found: error
        retention-days: 14

    - name: Upload Release APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-release-apk
        path: platforms/android/app/build/outputs/apk/release/*.apk
        if-no-files-found: warn
        retention-days: 14
