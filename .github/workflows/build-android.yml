name: Build Android APK and AAB

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'www.klsr.com' }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'www.klsr.com' }}

    steps:
    # ----------------------------------------------------
    # Checkout repository
    # ----------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # Setup Java (required for Android)
    # ----------------------------------------------------
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # ----------------------------------------------------
    # Setup Node.js
    # ----------------------------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # ----------------------------------------------------
    # Install Cordova
    # ----------------------------------------------------
    - name: Install Cordova
      run: |
        npm install -g cordova@12.0.0

    # ----------------------------------------------------
    # Verify web assets
    # ----------------------------------------------------
    - name: Verify web assets
      run: |
        if [ ! -d "www" ]; then
          echo "❌ www folder not found"
          exit 1
        fi
        if [ ! -f "config.xml" ]; then
          echo "❌ config.xml not found"
          exit 1
        fi
        echo "✅ Web assets OK"

    # ----------------------------------------------------
    # Fix config.xml namespace issue
    # ----------------------------------------------------
    - name: Fix config.xml
      run: |
        sed -i 's|xmlns:android="http://schemas.android.com/apk/res/android"||g' config.xml

    # ----------------------------------------------------
    # Create Cordova project
    # ----------------------------------------------------
    - name: Create Cordova project
      run: |
        cordova create cordova klsradio com.klsr.radio "KLS Radio"
        rm -rf cordova/www/*
        cp -R www/* cordova/www/
        cp config.xml cordova/

    # ----------------------------------------------------
    # Install ImageMagick for icon/splash
    # ----------------------------------------------------
    - name: Create splash screen and icon
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        mkdir -p cordova/www/images
        convert -size 1080x1920 xc:"#0a0f2d" cordova/www/images/splash.png
        convert -size 512x512 xc:"#0a0f2d" -fill "#d4af37" \
          -draw "circle 256,256 256,400" \
          -gravity center -pointsize 100 -fill white \
          -annotate +0+0 "KLS" cordova/www/images/icon.png

    # ----------------------------------------------------
    # Add Android platform
    # ----------------------------------------------------
    - name: Add Android platform
      run: |
        cd cordova
        cordova platform add android@13.0.0

    # ----------------------------------------------------
    # Install Cordova plugins
    # ----------------------------------------------------
    - name: Install plugins
      run: |
        cd cordova
        cordova plugin add cordova-plugin-whitelist@1.3.4
        cordova plugin add cordova-plugin-network-information@3.0.0
        cordova plugin add cordova-plugin-splashscreen@6.0.1
        cordova plugin add cordova-plugin-statusbar@4.0.0
        cordova plugin add cordova-plugin-device@2.1.0
        cordova plugin add cordova-plugin-file@8.1.3
        cordova plugin add cordova-plugin-android-permissions@1.1.3
        cordova plugin add cordova-plugin-media@5.0.3
        cordova plugin add cordova-plugin-background-mode@0.7.3

    # ----------------------------------------------------
    # Setup keystore
    # ----------------------------------------------------
    - name: Setup keystore
      run: |
        cd cordova
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > klsradio-release.keystore
        else
          keytool -genkey -v -keystore klsradio-release.keystore \
            -alias klsradio_release \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            -dname "CN=KLS Radio, OU=Mobile, O=Kingdom Lifestyle, L=Lagos, ST=Lagos, C=NG"
        fi

    # ----------------------------------------------------
    # Build Debug APK
    # ----------------------------------------------------
    - name: Build Debug APK
      run: |
        cd cordova
        cordova build android --debug

    # ----------------------------------------------------
    # Build Release AAB
    # ----------------------------------------------------
    - name: Build Release AAB
      run: |
        cd cordova
        cordova build android --release -- --packageType=bundle

    # ----------------------------------------------------
    # Build Release APK
    # ----------------------------------------------------
    - name: Build Release APK
      run: |
        cd cordova
        cordova build android --release

    # ----------------------------------------------------
    # Upload artifacts
    # ----------------------------------------------------
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-debug-apk
        path: cordova/platforms/android/app/build/outputs/apk/debug/*.apk

    - name: Upload Release AAB
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-release-aab
        path: cordova/platforms/android/app/build/outputs/bundle/release/*.aab

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: kls-radio-release-apk
        path: cordova/platforms/android/app/build/outputs/apk/release/*.apk
