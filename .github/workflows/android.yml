name: Build Android APK and AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 17 (REQUIRED for Cordova Android 13)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and dependencies
      run: |
        npm install -g cordova@12.0.0
        npm install
        
    - name: Clean and setup Android platform
      run: |
        # Remove existing platform
        cordova platform rm android --nosave 2>/dev/null || true
        
        # Add Android platform with specific Gradle version
        cordova platform add android@13.0.0
        
        # Verify platform was added
        ls -la platforms/android/
        
    - name: Ensure required plugins
      run: |
        # Remove existing plugins to avoid conflicts
        cordova plugin rm cordova-plugin-media 2>/dev/null || true
        cordova plugin rm cordova-plugin-background-mode 2>/dev/null || true
        cordova plugin rm cordova-plugin-network-information 2>/dev/null || true
        cordova plugin rm cordova-plugin-splashscreen 2>/dev/null || true
        cordova plugin rm cordova-plugin-statusbar 2>/dev/null || true
        
        # Add required plugins
        cordova plugin add cordova-plugin-network-information
        cordova plugin add cordova-plugin-splashscreen
        cordova plugin add cordova-plugin-statusbar
        cordova plugin add cordova-plugin-media@5.0.4
        cordova plugin add cordova-plugin-background-mode
        
    - name: Restore keystore from GitHub Secrets
      run: |
        # Decode the keystore from GitHub Secrets
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > klsradio-release.keystore
        
        # Verify keystore exists
        if [ -f "klsradio-release.keystore" ]; then
          echo "âœ… Keystore restored from GitHub Secrets"
          echo "ğŸ“„ File size: $(wc -c < klsradio-release.keystore) bytes"
          
          # Quick test to verify keystore
          if keytool -list -keystore klsradio-release.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" 2>/dev/null | grep -q "keystore"; then
            echo "ğŸ” Keystore verified as valid"
          else
            echo "âš ï¸ Could not verify keystore - might be wrong password or corrupted"
          fi
        else
          echo "âŒ ERROR: Keystore not restored!"
          exit 1
        fi
        
    - name: Prepare build environment
      run: |
        # Create build.json if it doesn't exist
        if [ ! -f "build.json" ]; then
          echo '{
            "android": {
              "release": {
                "keystore": "klsradio-release.keystore",
                "storePassword": "'"${{ secrets.KEYSTORE_PASSWORD }}"'",
                "alias": "'"${{ secrets.KEY_ALIAS }}"'",
                "password": "'"${{ secrets.KEY_PASSWORD }}"'",
                "keystoreType": "JKS"
              }
            }
          }' > build.json
        fi
        
        # Ensure gradlew is executable
        if [ -f "platforms/android/gradlew" ]; then
          chmod +x platforms/android/gradlew
        fi
        
    - name: Build Android Release AAB (SIMPLIFIED - using cordova command)
      run: |
        echo "ğŸš€ Building Release AAB (Signed Bundle)..."
        # Use cordova build command with proper signing
        cordova build android --release -- \
          --keystore=klsradio-release.keystore \
          --storePassword="${{ secrets.KEYSTORE_PASSWORD }}" \
          --alias="${{ secrets.KEY_ALIAS }}" \
          --password="${{ secrets.KEY_PASSWORD }}" \
          --packageType=bundle
        
        echo "âœ… Release AAB build completed"
        
    - name: Build Android Debug APK
      run: |
        echo "ğŸ”§ Building Debug APK..."
        cordova build android
        echo "âœ… Debug APK build completed"
        
    - name: Get AAB SHA1 fingerprint (CRITICAL CHECK)
      run: |
        # Check the generated AAB's SHA1 to verify it's correct
        echo "ğŸ” Looking for AAB file..."
        find platforms/android/app/build/outputs/ -type f -name "*.aab" 2>/dev/null || echo "Searching for AAB files..."
        
        AAB_FILE=$(find platforms/android/app/build/outputs/bundle/release -name "*.aab" 2>/dev/null | head -1)
        if [ -f "$AAB_FILE" ]; then
          echo "ğŸ“± Generated AAB file: $(basename "$AAB_FILE")"
          echo "ğŸ“Š File size: $(wc -c < "$AAB_FILE" | numfmt --to=iec) bytes"
          echo ""
          echo "ğŸ” SHA1 FINGERPRINT (MUST MATCH Google Play):"
          echo "================================================"
          SHA1_OUTPUT=$(keytool -printcert -jarfile "$AAB_FILE" 2>/dev/null)
          echo "$SHA1_OUTPUT" | grep -A1 "SHA1:" || echo "Could not extract SHA1"
          echo "================================================"
          
          # Extract just the SHA1 value
          SHA1_VALUE=$(echo "$SHA1_OUTPUT" | grep "SHA1:" | head -1 | tr -d ' ' | cut -d':' -f2-)
          if [ ! -z "$SHA1_VALUE" ]; then
            echo "$SHA1_VALUE" > sha1_fingerprint.txt
            echo "ğŸ“ SHA1 saved: $SHA1_VALUE"
            
            echo ""
            echo "ğŸ“‹ EXPECTED SHA1 from Google Play Console:"
            echo "EC:57:DA:A7:AD:F3:57:FA:5D:B1:A8:62:FC:28:5B:00:2D:CB:55:A4"
            echo ""
            
            if [ "$SHA1_VALUE" = "EC:57:DA:A7:AD:F3:57:FA:5D:B1:A8:62:FC:28:5B:00:2D:CB:55:A4" ]; then
              echo "âœ… âœ… âœ… SUCCESS: SHA1 matches! Ready for Google Play upload."
            else
              echo "âŒ âŒ âŒ WARNING: SHA1 DOES NOT MATCH!"
              echo "   The keystore in KEYSTORE_BASE64 secret is NOT the original one."
              echo "   Uploading this to Google Play will FAIL."
            fi
          else
            echo "âš ï¸ Could not extract SHA1 value"
            echo "Test" > sha1_fingerprint.txt
          fi
        else
          echo "âŒ No AAB file found at expected location!"
          echo "Trying to find any AAB files..."
          find . -name "*.aab" 2>/dev/null || echo "No AAB files found anywhere"
          echo "Test" > sha1_fingerprint.txt
        fi
        
    - name: Upload Release AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-release-aab
        path: platforms/android/app/build/outputs/bundle/release/*.aab
        if-no-files-found: warn
        retention-days: 7
        
    - name: Upload Debug APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: platforms/android/app/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
        retention-days: 7
        
    - name: Upload SHA1 fingerprint
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-info
        path: sha1_fingerprint.txt
        if-no-files-found: warn
        retention-days: 7
        
    - name: Show build summary and file structure
      if: always()
      run: |
        echo "=== BUILD SUMMARY ==="
        echo ""
        echo "ğŸ“ File structure check:"
        echo "Platforms directory:"
        ls -la platforms/android/ 2>/dev/null || echo "No platforms/android directory"
        echo ""
        echo "Build outputs:"
        find platforms/android/app/build/outputs/ -type f 2>/dev/null | head -30 || echo "No build outputs found"
        echo ""
        echo "ğŸ“¦ Artifacts generated (if successful):"
        echo "   â€¢ android-release-aab: For Google Play Store"
        echo "   â€¢ android-debug-apk: For testing"
        echo "   â€¢ build-info: Contains SHA1 fingerprint"
        echo ""
        echo "âš ï¸ IMPORTANT: Check SHA1 fingerprint above!"
        echo "   If it matches expected SHA1, upload to Google Play."
        echo "   If not, update KEYSTORE_BASE64 secret with ORIGINAL keystore."
