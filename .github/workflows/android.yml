name: Build Android APK and AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 17 (REQUIRED for Cordova Android 13)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and dependencies
      run: |
        npm install -g cordova@12.0.0
        npm install
        
    - name: Clean and setup Android platform
      run: |
        # Remove existing platform
        cordova platform rm android --nosave 2>/dev/null || true
        
        # Add Android platform with specific Gradle version
        cordova platform add android@13.0.0
        
        # Verify platform was added
        ls -la platforms/android/
        
    - name: Install ONLY essential plugins (MINIMAL PERMISSIONS)
      run: |
        # Remove ALL plugins first to avoid conflicts
        cordova plugin rm --all 2>/dev/null || true
        
        # Install only essential plugins (no permission-heavy plugins)
        cordova plugin add cordova-plugin-whitelist
        cordova plugin add cordova-plugin-file
        cordova plugin add cordova-plugin-network-information
        cordova plugin add cordova-plugin-device
        cordova plugin add cordova-plugin-splashscreen
        cordova plugin add cordova-plugin-statusbar
        cordova plugin add cordova-plugin-media@5.0.3
        cordova plugin add cordova-plugin-background-mode
        cordova plugin add cordova-plugin-powermanagement
        
        # DO NOT install these (they add unnecessary permissions):
        # cordova-plugin-android-permissions
        # cordova-plugin-music-controls2
        # cordova-plugin-geolocation
        # cordova-plugin-camera
        
        # List installed plugins for verification
        echo "‚úÖ Installed plugins:"
        cordova plugin ls
        
    - name: Restore keystore from GitHub Secrets
      run: |
        # Decode the keystore from GitHub Secrets
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > klsradio-release.keystore
        
        # Verify keystore exists
        if [ -f "klsradio-release.keystore" ]; then
          echo "‚úÖ Keystore restored from GitHub Secrets"
          echo "üìÑ File size: $(wc -c < klsradio-release.keystore) bytes"
          
          # Quick test to verify keystore
          if keytool -list -keystore klsradio-release.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" 2>/dev/null | grep -q "keystore"; then
            echo "üîê Keystore verified as valid"
          else
            echo "‚ö†Ô∏è Could not verify keystore - might be wrong password or corrupted"
          fi
        else
          echo "‚ùå ERROR: Keystore not restored!"
          exit 1
        fi
        
    - name: Prepare build environment
      run: |
        # Create build.json if it doesn't exist
        if [ ! -f "build.json" ]; then
          echo '{
            "android": {
              "release": {
                "keystore": "klsradio-release.keystore",
                "storePassword": "'"${{ secrets.KEYSTORE_PASSWORD }}"'",
                "alias": "'"${{ secrets.KEY_ALIAS }}"'",
                "password": "'"${{ secrets.KEY_PASSWORD }}"'",
                "keystoreType": "JKS"
              }
            }
          }' > build.json
        fi
        
    - name: Build Android Release AAB (Version 12.0.9)
      run: |
        echo "üöÄ Building Release AAB v12.0.9 (Signed Bundle)..."
        echo "‚ö†Ô∏è NOTE: Only minimal permissions for radio streaming"
        
        # Use cordova build command with proper signing
        cordova build android --release -- \
          --keystore=klsradio-release.keystore \
          --storePassword="${{ secrets.KEYSTORE_PASSWORD }}" \
          --alias="${{ secrets.KEY_ALIAS }}" \
          --password="${{ secrets.KEY_PASSWORD }}" \
          --packageType=bundle
        
        echo "‚úÖ Release AAB build completed"
        
    - name: Build Android Debug APK
      run: |
        echo "üîß Building Debug APK..."
        cordova build android
        echo "‚úÖ Debug APK build completed"
        
    - name: Get AAB SHA1 fingerprint (CRITICAL CHECK)
      run: |
        # Check the generated AAB's SHA1 to verify it's correct
        echo "üîç Looking for AAB file..."
        
        AAB_FILE=$(find platforms/android/app/build/outputs/bundle/release -name "*.aab" 2>/dev/null | head -1)
        if [ -f "$AAB_FILE" ]; then
          echo "üì± Generated AAB file: $(basename "$AAB_FILE")"
          echo "üìä File size: $(wc -c < "$AAB_FILE" | numfmt --to=iec) bytes"
          echo ""
          echo "üîê SHA1 FINGERPRINT (MUST MATCH Google Play):"
          echo "================================================"
          SHA1_OUTPUT=$(keytool -printcert -jarfile "$AAB_FILE" 2>/dev/null)
          echo "$SHA1_OUTPUT" | grep -A1 "SHA1:" || echo "Could not extract SHA1"
          echo "================================================"
          
          # Extract just the SHA1 value
          SHA1_VALUE=$(echo "$SHA1_OUTPUT" | grep "SHA1:" | head -1 | tr -d ' ' | cut -d':' -f2-)
          if [ ! -z "$SHA1_VALUE" ]; then
            echo "$SHA1_VALUE" > sha1_fingerprint.txt
            echo "üìù SHA1 saved: $SHA1_VALUE"
            
            echo ""
            echo "üìã EXPECTED SHA1 from Google Play Console:"
            echo "EC:57:DA:A7:AD:F3:57:FA:5D:B1:A8:62:FC:28:5B:00:2D:CB:55:A4"
            echo ""
            
            if [ "$SHA1_VALUE" = "EC:57:DA:A7:AD:F3:57:FA:5D:B1:A8:62:FC:28:5B:00:2D:CB:55:A4" ]; then
              echo "‚úÖ ‚úÖ ‚úÖ SUCCESS: SHA1 matches! Ready for Google Play upload."
            else
              echo "‚ùå ‚ùå ‚ùå WARNING: SHA1 DOES NOT MATCH!"
              echo "   The keystore in KEYSTORE_BASE64 secret is NOT the original one."
              echo "   Uploading this to Google Play will FAIL."
            fi
          else
            echo "‚ö†Ô∏è Could not extract SHA1 value"
            echo "Test" > sha1_fingerprint.txt
          fi
        else
          echo "‚ùå No AAB file found at expected location!"
          echo "Trying to find any AAB files..."
          find . -name "*.aab" 2>/dev/null || echo "No AAB files found anywhere"
          echo "Test" > sha1_fingerprint.txt
        fi
        
    - name: Check APK/AAB permissions (IMPORTANT)
      run: |
        echo "üîç Checking permissions in generated files..."
        APK_FILE=$(find platforms/android/app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "üì± Debug APK permissions:"
          aapt dump permissions "$APK_FILE" 2>/dev/null | grep "android.permission" || echo "Could not extract permissions"
        fi
        
        AAB_FILE=$(find platforms/android/app/build/outputs/bundle/release -name "*.aab" 2>/dev/null | head -1)
        if [ -f "$AAB_FILE" ]; then
          echo ""
          echo "üì± Release AAB permissions:"
          # Extract base module to check permissions
          unzip -p "$AAB_FILE" "base/manifest/AndroidManifest.xml" > /tmp/base_manifest.xml 2>/dev/null && \
          aapt dump xmltree /tmp/base_manifest.xml 2>/dev/null | grep "android.permission" || echo "Could not extract AAB permissions"
        fi
        
    - name: Upload Release AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-release-aab-v12.0.9
        path: platforms/android/app/build/outputs/bundle/release/*.aab
        if-no-files-found: warn
        retention-days: 7
        
    - name: Upload Debug APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk-v12.0.9
        path: platforms/android/app/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
        retention-days: 7
        
    - name: Upload SHA1 fingerprint
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-info-v12.0.9
        path: sha1_fingerprint.txt
        if-no-files-found: warn
        retention-days: 7
        
    - name: Show build summary
      if: always()
      run: |
        echo "=== BUILD SUMMARY (v12.0.9) ==="
        echo ""
        echo "üì¶ Artifacts generated:"
        echo "   ‚Ä¢ android-release-aab-v12.0.9: For Google Play Store"
        echo "   ‚Ä¢ android-debug-apk-v12.0.9: For testing"
        echo "   ‚Ä¢ build-info-v12.0.9: Contains SHA1 fingerprint"
        echo ""
        echo "‚úÖ Permissions minimized for radio app:"
        echo "   ‚Ä¢ INTERNET (required for streaming)"
        echo "   ‚Ä¢ ACCESS_NETWORK_STATE (connection checks)"
        echo "   ‚Ä¢ FOREGROUND_SERVICE (background audio)"
        echo "   ‚Ä¢ WAKE_LOCK (keep screen on)"
        echo ""
        echo "üö´ Removed problematic permissions:"
        echo "   ‚Ä¢ BLUETOOTH/BLUETOOTH_ADMIN (unless needed)"
        echo "   ‚Ä¢ POST_NOTIFICATIONS (Android 13+ handled differently)"
        echo "   ‚Ä¢ Location/Camera/Contacts permissions"
        echo ""
        echo "‚ö†Ô∏è IMPORTANT:"
        echo "   1. Check SHA1 fingerprint matches expected"
        echo "   2. Upload AAB to Google Play"
        echo "   3. This version should have only 4 permissions (matching previous)"
