name: Build Android APK and AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Install Cordova
      run: |
        npm install -g cordova@12.0.0
        
    - name: Clean previous builds
      run: |
        rm -rf platforms
        rm -rf plugins
        rm -rf node_modules
        
    - name: Install dependencies
      run: |
        npm install
        
    - name: Add Android platform
      run: |
        cordova platform add android@13.0.0
        
    - name: Generate keystore in GitHub Actions
      run: |
        # Generate a new keystore with your specified details
        keytool -genkeypair \
          -v \
          -keystore klsradio-release.keystore \
          -storepass "www.klsr.com" \
          -alias "klsradio_release" \
          -keypass "www.klsr.com" \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=KLS Radio, OU=Kingdom Lifestyle Radio, O=KLS Radio, L=Lagos, ST=Lagos, C=NG" \
          -storetype JKS
        
        # Verify the keystore was created
        echo "Keystore generated successfully!"
        ls -la klsradio-release.keystore
        
    - name: Verify keystore content
      run: |
        keytool -list -v -keystore klsradio-release.keystore -storepass "www.klsr.com"
        
    - name: Create or update build.json
      run: |
        # Create build.json with the generated keystore
        cat > build.json << 'EOF'
{
  "android": {
    "release": {
      "keystore": "klsradio-release.keystore",
      "storePassword": "www.klsr.com",
      "alias": "klsradio_release",
      "password": "www.klsr.com",
      "keystoreType": "JKS"
    }
  }
}
EOF
        
        echo "build.json created:"
        cat build.json
        
    - name: Build Android Debug APK
      run: |
        cordova build android
        
    - name: Build Android Release AAB
      run: |
        cordova build android --release -- --packageType=bundle
        
    - name: Upload Debug APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: platforms/android/app/build/outputs/apk/debug/*.apk
        
    - name: Upload Release AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-release-aab
        path: platforms/android/app/build/outputs/bundle/release/*.aab
        
    - name: Clean up generated keystore
      run: |
        rm -f klsradio-release.keystore
        rm -f build.json
