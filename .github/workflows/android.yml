name: Build Android APK and AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 17 (REQUIRED for Cordova Android 13)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and dependencies
      run: |
        npm install -g cordova@12.0.0
        npm install
        
    - name: Clean and setup Android platform
      run: |
        # Remove existing platform
        cordova platform rm android --nosave 2>/dev/null || true
        
        # Add Android platform with specific Gradle version
        cordova platform add android@13.0.0
        
    - name: Ensure required plugins
      run: |
        # Remove existing plugins to avoid conflicts
        cordova plugin rm cordova-plugin-media 2>/dev/null || true
        cordova plugin rm cordova-plugin-background-mode 2>/dev/null || true
        cordova plugin rm cordova-plugin-network-information 2>/dev/null || true
        cordova plugin rm cordova-plugin-splashscreen 2>/dev/null || true
        cordova plugin rm cordova-plugin-statusbar 2>/dev/null || true
        
        # Add required plugins
        cordova plugin add cordova-plugin-network-information
        cordova plugin add cordova-plugin-splashscreen
        cordova plugin add cordova-plugin-statusbar
        cordova plugin add cordova-plugin-media@5.0.4
        cordova plugin add cordova-plugin-background-mode
        
    - name: Restore keystore from GitHub Secrets
      run: |
        # Decode the keystore from GitHub Secrets
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > klsradio-release.keystore
        
        # Verify keystore exists
        if [ -f "klsradio-release.keystore" ]; then
          echo "‚úÖ Keystore restored from GitHub Secrets"
          echo "üìÑ File size: $(wc -c < klsradio-release.keystore) bytes"
          
          # Quick test to verify keystore
          if keytool -list -keystore klsradio-release.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" 2>/dev/null | grep -q "keystore"; then
            echo "üîê Keystore verified as valid"
          else
            echo "‚ö†Ô∏è Could not verify keystore - might be wrong password or corrupted"
          fi
        else
          echo "‚ùå ERROR: Keystore not restored!"
          exit 1
        fi
        
    - name: Set Gradle properties for Java 17
      run: |
        # Create or update gradle.properties for Java 17 compatibility
        echo "org.gradle.java.home=/usr/lib/jvm/temurin-17-jdk-amd64" > platforms/android/gradle.properties
        echo "android.enableJetifier=true" >> platforms/android/gradle.properties
        echo "android.useAndroidX=true" >> platforms/android/gradle.properties
        echo "org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m" >> platforms/android/gradle.properties
        
    - name: Build Android Release AAB
      run: |
        echo "üöÄ Building Release AAB (Signed Bundle)..."
        # Build with explicit Gradle wrapper
        cd platforms/android
        ./gradlew bundleRelease -PcdvReleaseSigningPropertiesFile=../../../build.json
        cd ../..
        
    - name: Build Android Debug APK
      run: |
        echo "üîß Building Debug APK..."
        cordova build android
        
    - name: Get AAB SHA1 fingerprint (CRITICAL CHECK)
      run: |
        # Check the generated AAB's SHA1 to verify it's correct
        AAB_FILE=$(find platforms/android/app/build/outputs/bundle/release -name "*.aab" | head -1)
        if [ -f "$AAB_FILE" ]; then
          echo "üì± Generated AAB file: $(basename "$AAB_FILE")"
          echo "üìä File size: $(wc -c < "$AAB_FILE" | numfmt --to=iec) bytes"
          echo ""
          echo "üîê SHA1 FINGERPRINT (MUST MATCH Google Play):"
          echo "================================================"
          SHA1_OUTPUT=$(keytool -printcert -jarfile "$AAB_FILE" 2>/dev/null | grep -A1 "SHA1:" | head -2)
          echo "$SHA1_OUTPUT"
          echo "================================================"
          
          # Extract just the SHA1 value
          SHA1_VALUE=$(echo "$SHA1_OUTPUT" | grep "SHA1:" | head -1 | tr -d ' ' | cut -d':' -f2-)
          echo "$SHA1_VALUE" > sha1_fingerprint.txt
          
          echo ""
          echo "üìã EXPECTED SHA1 from Google Play Console:"
          echo "EC:57:DA:A7:AD:F3:57:FA:5D:B1:A8:62:FC:28:5B:00:2D:CB:55:A4"
          echo ""
          
          if [ "$SHA1_VALUE" = "EC:57:DA:A7:AD:F3:57:FA:5D:B1:A8:62:FC:28:5B:00:2D:CB:55:A4" ]; then
            echo "‚úÖ ‚úÖ ‚úÖ SUCCESS: SHA1 matches! Ready for Google Play upload."
          else
            echo "‚ùå ‚ùå ‚ùå WARNING: SHA1 DOES NOT MATCH!"
            echo "   The keystore in KEYSTORE_BASE64 secret is NOT the original one."
            echo "   Uploading this to Google Play will FAIL."
          fi
        else
          echo "‚ùå No AAB file found!"
          # Show what files exist for debugging
          find platforms/android/app/build/outputs/ -type f 2>/dev/null | head -20 || echo "No build outputs found"
        fi
        
    - name: Upload Release AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-release-aab
        path: platforms/android/app/build/outputs/bundle/release/*.aab
        retention-days: 7
        
    - name: Upload Debug APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: platforms/android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: Upload SHA1 fingerprint
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-info
        path: sha1_fingerprint.txt
        retention-days: 7
        
    - name: Show build summary
      if: always()
      run: |
        echo "=== BUILD SUMMARY ==="
        echo "üì¶ Artifacts generated:"
        echo "   ‚Ä¢ android-release-aab: For Google Play Store"
        echo "   ‚Ä¢ android-debug-apk: For testing"
        echo "   ‚Ä¢ build-info: Contains SHA1 fingerprint"
        echo ""
        echo "‚ö†Ô∏è IMPORTANT: Check SHA1 fingerprint above!"
        echo "   If it matches expected SHA1, upload to Google Play."
        echo "   If not, update KEYSTORE_BASE64 secret with ORIGINAL keystore."
